<!DOCTYPE html>
<HTML>
<HEAD>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet"
          href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.css" />
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.2.js"
            type="text/javascript"></script>
    <script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.js"></script>
    <!--
     <link rel="stylesheet" href="jquery.mobile-1.3.2.min.css" />
    <script src="jquery-1.9.1.min.js" type="text/javascript"></script>
      <script src="jquery.mobile-1.3.2.min.js"></script>
     -->

    <script type="text/javascript">

        var accountKey = "yKMkJwJ88+Yv7HAtUH1HyNYIZOQKrwu7i5aClgRNH8w";
        var accountKeyEncoded = base64_encode(":" + accountKey);

        jQuery.support.cors = true;

        $(document).ready(function(){
            //Hook up an onclick eventhandler to the Search button.
            $("#Search").click(GetBing);
            $("#popupcontent").css('height', ($(window).height()-45)+"px");
            $("#preview_ok_btn").click(storeImage);
            $("#reject").click(function(){
                $( "#popup" ).dialog( "close" );
            });
        });
        var storeImage= function(){
            alert($( "#popupimg" ).attr('src'));
            var url=$( "#popupimg" ).attr('src');
            var requestStr = "http://www.stutzen.me/addPhoto?title=emotedemo&url="+url;
            $.ajax({
                url: requestStr,
                error: function (jqXHR, textStatus, errorThrown) {
                    alert (textStatus);
                },success: function (data, status) {
                    window.location = "http://www.stutzen.me/lab/emote/feed-v2.html"
                }
            });
        }
        function setHeader(xhr) {
            xhr.setRequestHeader('Authorization', "Basic " + accountKeyEncoded);

        }

        function GetBing() {
            //Build up the URL for the request
            var  query = $("#Query").val();
            if(query.length<1) return;
//https://api.datamarket.azure.com/Bing/Search/Composite?Sources=%27Web%2BNews%27&Query=
            var requestStr = "https://api.datamarket.azure.com/Data.ashx/Bing/Search/v1/Image?Query=%27"+query+"%27&$top=20&$format=json&ImageFilters=%27Aspect%3aWide%2bSize%3aMedium%27";

            $.ajax({
                url: requestStr,
                beforeSend: setHeader,
                dataType:'json',
                context: this,
                type: 'GET',
                success: function (data, status) {
                    var results = data;
                    var tbl="";//<table cellspacing=5 cellpadding=5 style=\"width:100%;border 1px solid black\">";
                    $.each(data.d.results, function (i) {

                                /*<a href="dialog-rightclosebtn.html" data-role="button" data-inline="true" data-rel="dialog" data-transition="pop" data-corners="true" data-shadow="true" data-iconshadow="true" data-wrapperels="span" data-theme="c" class="ui-btn ui-shadow ui-btn-corner-all ui-btn-inline ui-btn-up-c">
                                 <span class="ui-btn-inner"><span class="ui-btn-text">Right close button</span></span></a>*/
                                tbl+="<a href='#popup' data-inline='true' data-transition='slideup'>" +
                                       "<div class='box' ><img class='imag' src='" + data.d.results[i].Thumbnail.MediaUrl + "' imageurl="+data.d.results[i].MediaUrl+" /></div></a>";

                            }


                    );
                    //tbl+="</table>";
                    $("#Results").append(tbl);
                    //  $("#SearchContainer").hide();

                    $( ".imag" ).click(function(e) {
                        $( "#popupimg" ).attr('src', this.attributes['imageurl'].value );
                        $( "#popup" ).dialog( "open" );
                    });

                    recalc();

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert (textStatus);
                }
            });
        }

        function recalc()
        {
            var box = $('.box').width();
            $('.box').css('height', box);
        }


        $(window).resize(function(){
            recalc();
        });



        function showResults(item){
            var p=document.createElement('p');
            var a=document.createElement('a');
            var i=document.createElement('img');
            a.href=item.MediaUrl;
            i.src=item.Thumbnail.MediaUrl;
            $(a).append(i);
            $(p).append(item.Title);
//$('#Results').append(a,p);
        }
        function base64_encode(data) {

            var b64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
            var o1, o2, o3, h1, h2, h3, h4, bits, i = 0,
                    ac = 0,
                    enc = "",
                    tmp_arr = [];

            if (!data) {
                return data;
            }

            do { // pack three octets into four hexets
                o1 = data.charCodeAt(i++);
                o2 = data.charCodeAt(i++);
                o3 = data.charCodeAt(i++);

                bits = o1 << 16 | o2 << 8 | o3;

                h1 = bits >> 18 & 0x3f;
                h2 = bits >> 12 & 0x3f;
                h3 = bits >> 6 & 0x3f;
                h4 = bits & 0x3f;

                // use hexets to index into b64, and append result to encoded string
                tmp_arr[ac++] = b64.charAt(h1) + b64.charAt(h2) + b64.charAt(h3) + b64.charAt(h4);
            } while (i < data.length);

            enc = tmp_arr.join('');

            var r = data.length % 3;

            return (r ? enc.slice(0, r - 3) : enc) + '==='.slice(r || 3);

        }

    </script>
    <style>
        html,body {
            border: none;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .imag {
            height: 100%;
            width: 100%;
        }

        .box {
            float: left;
            display: block;
            width: 30%;
        }
        .centeredImage
        {
            text-align:center;
            display:block;
        }
    </style>
</HEAD>

<BODY style="width: 100%">
<div data-role="page" id="search" style="max-height: 420px; min-height: 420px;" data-theme="a">
    <div id="SearchContainer" align="center">
        <input type="text" id="Query" />
        <input type="button" value="Search!" id="Search" />
    </div>
    <table id="Results" cellspacing="10" cellpadding="10"
           style="border: 1px solid black;">
    </table>
    <!-- <a href="#popup" data-role="button" data-rel="dialog"
        data-transition="pop" data-inline="true">open</a> -->

    <!-- <a href='#popup' data-inline='true' data-rel='dialog' data-transition='pop'><div class='box' >test</div></a>  -->
</div>
<div data-role="page" id="popup" >
    <div data-role="header" data-position="fixed">
        <h1>Preview</h1>
    </div>
    <div data-role="content" id="popupcontent">
        <div style="text-align:center">
            <img id="popupimg" src="" width="100%" />
        </div>
    </div>
    <div data-role="footer" class="ui-bar" data-position="fixed">
        <a href="" style="width:46%;" id="preview_ok_btn">Ok</a>
        <a href="" data-rel="back" data-transition='slidedown' style="width:45%;">Cancel</a>
        <!-- <input type="button" value="Ok" style="width:50%;"/> <input type="button" id="reject" value="Cancel" style="width:50%;"/> -->
    </div>
</div>

<!-- <div data-role="dialog" id="popup" style="width:100%">
    <div data-role="header">
        <h1>Preview</h1>
    </div>
    <div data-role="content" id="popupcontent">
        <img id="popupimg" src="" /> <br />
        <div data-role="controlgroup" data-type="horizontal" class="popupbtncontainer">
        <input type="button" value="Ok" style="width:50%;"/> <input type="button" id="reject" value="Cancel" style="width:50%;"/>
        </div>
    </div>
</div> -->
</BODY>
</HTML>